---
phase: 01-bug-fixes-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/sync/SyncEngine.ts
  - backend/src/services/room/RoomManager.ts
  - backend/src/services/sync/versionUtils.ts
autonomous: true

must_haves:
  truths:
    - "Version number increments on every state change including track changes"
    - "Version number never resets to 0 during room lifetime"
    - "Version wraps to 1 when exceeding 2^50 threshold"
    - "Rapid track changes are debounced (only last one processed)"
    - "Stale updates are correctly rejected using version comparison that handles wrap-around"
  artifacts:
    - path: "backend/src/services/sync/versionUtils.ts"
      provides: "incrementVersion and isVersionNewer utility functions"
      exports: ["incrementVersion", "isVersionNewer", "MAX_VERSION"]
    - path: "backend/src/services/sync/SyncEngine.ts"
      provides: "Fixed handleSyncUpdate without version reset"
      contains: "incrementVersion"
    - path: "backend/src/services/room/RoomManager.ts"
      provides: "updateSyncState using incrementVersion"
      contains: "incrementVersion"
  key_links:
    - from: "backend/src/services/sync/SyncEngine.ts"
      to: "backend/src/services/sync/versionUtils.ts"
      via: "import incrementVersion, isVersionNewer"
      pattern: "import.*versionUtils"
    - from: "backend/src/services/room/RoomManager.ts"
      to: "backend/src/services/sync/versionUtils.ts"
      via: "import incrementVersion"
      pattern: "import.*versionUtils"
---

<objective>
Fix BUGF-01: Version number resets to 0 on track change, breaking optimistic concurrency control.

Purpose: The version reset on line 96 of SyncEngine.ts (`version: isNewTrack ? 0 : currentState.version + 1`) causes playlist sync ordering to break. Version must be monotonically increasing per room lifetime per user decision.
Output: Server-authoritative version management with wrap-around safety and track change debouncing.
</objective>

<execution_context>
@C:/Users/MiaowFISH/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/MiaowFISH/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bug-fixes-foundation/01-RESEARCH.md

@backend/src/services/sync/SyncEngine.ts
@backend/src/services/room/RoomManager.ts
@shared/types/entities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version utility and fix SyncEngine version reset</name>
  <files>backend/src/services/sync/versionUtils.ts, backend/src/services/sync/SyncEngine.ts</files>
  <action>
1. Create `backend/src/services/sync/versionUtils.ts` with:
   - `MAX_VERSION = Math.pow(2, 50)` constant
   - `incrementVersion(current: number): number` — returns `current >= MAX_VERSION ? 1 : current + 1`
   - `isVersionNewer(incoming: number, current: number): boolean` — handles wrap-around: if `Math.abs(diff) > MAX_VERSION / 2`, smaller number is newer; otherwise `incoming > current`

2. Fix `SyncEngine.ts` `handleSyncUpdate` method:
   - Import `incrementVersion` and `isVersionNewer` from `./versionUtils`
   - Remove the `isNewTrack` variable and all its usages (lines 82, 84, 96)
   - Replace stale update check (line 84) with: use `isVersionNewer` — if client provides a version and it's NOT newer than current, reject as stale. But note: the server is the authority, so the stale check should compare client's version against server's current version. If `newSyncState.version !== undefined && newSyncState.version < currentState.version`, reject. Use `isVersionNewer` for the comparison to handle wrap-around.
   - Replace line 96 (`version: isNewTrack ? 0 : currentState.version + 1`) with `version: incrementVersion(currentState.version)` — always increment, never reset, regardless of whether track changed.

3. Add track change debounce to SyncEngine:
   - Add a private `trackChangeTimers: Map<string, NodeJS.Timeout>` field
   - Add a private `TRACK_CHANGE_DEBOUNCE = 300` constant (300ms, leading edge per user decision)
   - In `handleSyncUpdate`, detect track change (newSyncState.trackId !== currentState.trackId && newSyncState.trackId !== null). If track change detected:
     - Check if a debounce timer exists for this roomId. If yes, clear it and reject this update (return success: false, error: 'Debounced').
     - If no timer, process the update normally and set a debounce timer for 300ms that just clears itself from the map when it fires.
   - This implements leading-edge debounce: first track change goes through immediately, subsequent ones within 300ms are dropped.
   - Clean up timers in `cleanupRoom` method.

Do NOT modify the version check in `RoomManager.updateSyncState` yet — that's Task 2.
  </action>
  <verify>
Run `cd D:\Codespace\musesync && yarn workspace backend type-check` to verify TypeScript compilation passes. Manually inspect that:
- `versionUtils.ts` exports `incrementVersion`, `isVersionNewer`, `MAX_VERSION`
- `SyncEngine.ts` no longer contains `isNewTrack` variable
- `SyncEngine.ts` line that was `version: isNewTrack ? 0 :` now uses `incrementVersion`
  </verify>
  <done>SyncEngine.handleSyncUpdate always increments version (never resets to 0), uses wrap-around-safe comparison for stale detection, and debounces rapid track changes at 300ms leading edge.</done>
</task>

<task type="auto">
  <name>Task 2: Fix RoomManager.updateSyncState to use version utility</name>
  <files>backend/src/services/room/RoomManager.ts</files>
  <action>
Fix `RoomManager.updateSyncState` method (line 236):
- Import `incrementVersion` from `../sync/versionUtils`
- Current code: `room.syncState = { ...syncState, version: room.syncState.version + 1 };`
- This double-increments because SyncEngine already increments before calling updateSyncState.
- Change to: `room.syncState = syncState;` — accept the version as-is from SyncEngine, since SyncEngine is now the single authority for version increment.
- This eliminates the double-increment bug where version jumps by 2 on each update.

Also update `createRoom` initial sync state:
- Change `version: 0` to `version: 1` in the initial SyncState (line 61). Per user decision, version starts at 1 when room is created.
  </action>
  <verify>
Run `cd D:\Codespace\musesync && yarn workspace backend type-check` to verify TypeScript compilation passes. Verify that:
- `updateSyncState` no longer does `version: room.syncState.version + 1`
- `createRoom` initial version is 1, not 0
  </verify>
  <done>Version increment happens exactly once per update (in SyncEngine only), initial room version is 1, no double-increment bug.</done>
</task>

</tasks>

<verification>
- `yarn workspace backend type-check` passes with no errors
- SyncEngine.ts contains no reference to `isNewTrack`
- SyncEngine.ts uses `incrementVersion()` for version management
- RoomManager.ts `updateSyncState` accepts version as-is from caller
- RoomManager.ts `createRoom` starts version at 1
- versionUtils.ts exports are importable
</verification>

<success_criteria>
Version number persists correctly across track changes without resetting to 0. Version always increments monotonically. Rapid track changes are debounced. Version wrap-around is handled safely at 2^50 threshold.
</success_criteria>

<output>
After completion, create `.planning/phases/01-bug-fixes-foundation/01-01-SUMMARY.md`
</output>
