---
phase: 03-background-playback-network-recovery
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Music continues playing when app moves to background on iOS and Android"
    - "Lock screen shows playback controls (play/pause/skip) on both platforms"
    - "App detects network disconnection and displays status to user"
    - "App automatically reconnects and resyncs playback position after network recovery"
    - "Stale state (older than 60s) is rejected and not propagated to other clients"
    - "App reconciles sync state when returning to foreground after background playback"
  artifacts: []
  key_links: []
---

<objective>
Verify all Phase 3 features work correctly on real devices.

Purpose: Background playback and network recovery require real device testing — Expo Go and simulators may not fully support background audio modes, lock screen controls, or real network disconnection scenarios.

Output: Verified phase completion or list of issues to fix
</objective>

<execution_context>
@C:/Users/MiaowFISH/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/MiaowFISH/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-playback-network-recovery/03-01-SUMMARY.md
@.planning/phases/03-background-playback-network-recovery/03-02-SUMMARY.md
@.planning/phases/03-background-playback-network-recovery/03-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Manual verification of Phase 3 features on real device</name>
  <files></files>
  <action>
    Present the following test plan to the user for manual verification on a physical device.

    Complete Phase 3 implementation includes:
    1. Background audio playback with lock screen controls (play/pause/skip/progress/metadata)
    2. AppState lifecycle management (background independence + foreground resync)
    3. Network disconnection detection with banner UI
    4. Automatic reconnection with exponential backoff + manual retry fallback
    5. Post-reconnection and post-foreground state reconciliation with Toast notifications
    6. Stale state rejection (>60s)
    7. Server-side heartbeat timeout enforcement (60s)
    8. Offline playback behavior (current track continues, no auto-advance)

    Test 1 — Background Playback (BGPB-01, BGPB-02):
    Start playing a song in a room, press home to background, verify music continues for 30+ seconds.

    Test 2 — Lock Screen Controls (BGPB-03):
    Check lock screen/notification shade shows song title, artist, cover art. Test play/pause, skip next/prev, progress seek.

    Test 3 — Foreground Reconciliation (BGPB-04):
    Two devices in same room. Background Device B, change track on Device A, return Device B to foreground. Verify sync + Toast + smooth transition.

    Test 4 — Network Disconnection Banner (NETR-01):
    Enable airplane mode while playing. Verify red/yellow banner appears. Current song continues, stops after finishing (no auto-advance).

    Test 5 — Auto-Reconnection (NETR-02, NETR-03):
    Disable airplane mode. Verify auto-reconnect, banner dismisses, room state resyncs with Toast.

    Test 6 — Manual Retry (NETR-02 fallback):
    Airplane mode until all retries fail. Verify "连接失败" banner with "重新连接" button. Disable airplane, tap button, verify reconnection.

    Test 7 — Stale State Rejection (NETR-04):
    Check console logs for stale state rejection when server timestamp is >60s old.

    Test 8 — Server Heartbeat (NETR-05):
    Force-kill client, wait 60+ seconds, verify server logs show member timeout.
  </action>
  <verify>User confirms all tests pass or reports specific failures.</verify>
  <done>All 6 roadmap success criteria verified on at least one physical device, or issues identified for gap closure.</done>
</task>

</tasks>

<verification>
All 6 success criteria from the roadmap must be verified:
1. Music continues playing when app moves to background on iOS and Android
2. Lock screen shows playback controls (play/pause/skip) on both platforms
3. App detects network disconnection and displays status to user
4. App automatically reconnects and resyncs playback position after network recovery
5. Stale state (older than 60s) is rejected and not propagated to other clients
6. App reconciles sync state when returning to foreground after background playback
</verification>

<success_criteria>
All 8 test scenarios pass on at least one physical device (iOS or Android).
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-playback-network-recovery/03-04-SUMMARY.md`
</output>
