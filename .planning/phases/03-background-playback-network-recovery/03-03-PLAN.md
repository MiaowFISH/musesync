---
phase: 03-background-playback-network-recovery
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/src/services/sync/NetworkMonitor.ts
  - app/src/hooks/useNetworkStatus.ts
  - app/src/components/common/NetworkBanner.tsx
  - app/src/services/sync/SocketManager.ts
  - app/src/screens/PlayerScreen.tsx
  - app/src/App.tsx
  - app/package.json
autonomous: true

must_haves:
  truths:
    - "App detects network disconnection and displays a banner at top of player screen"
    - "Banner shows '网络已断开，正在重连...' during disconnection with red/yellow styling"
    - "App automatically reconnects with exponential backoff (1s, 2s, 4s...)"
    - "After max retry failures, banner shows '重新连接' button for manual retry"
    - "After reconnection, app automatically resyncs room state and shows Toast with changes"
    - "Audio continues playing current buffered track when offline, stops after current track ends (no auto-advance)"
    - "Banner dismisses automatically after successful reconnection"
  artifacts:
    - path: "app/src/services/sync/NetworkMonitor.ts"
      provides: "NetInfo wrapper that monitors connectivity and emits status changes"
      exports: ["NetworkMonitor", "networkMonitor", "NetworkStatus"]
    - path: "app/src/hooks/useNetworkStatus.ts"
      provides: "React hook exposing network status and socket connection state"
      exports: ["useNetworkStatus"]
    - path: "app/src/components/common/NetworkBanner.tsx"
      provides: "Dismissable banner component showing disconnection status with manual retry button"
      exports: ["NetworkBanner"]
  key_links:
    - from: "app/src/services/sync/NetworkMonitor.ts"
      to: "app/src/services/sync/SocketManager.ts"
      via: "triggers reconnection on network recovery"
      pattern: "socketManager\\.connect|networkMonitor"
    - from: "app/src/services/sync/NetworkMonitor.ts"
      to: "app/src/services/sync/StateReconciler.ts"
      via: "triggers reconciliation after reconnection"
      pattern: "stateReconciler\\.reconcile"
    - from: "app/src/components/common/NetworkBanner.tsx"
      to: "app/src/hooks/useNetworkStatus.ts"
      via: "reads network and connection state for display"
      pattern: "useNetworkStatus"
---

<objective>
Implement network disconnection detection, visual feedback, enhanced reconnection, and post-reconnection state sync.

Purpose: Users need clear feedback when network drops, confidence that reconnection is automatic, and a manual fallback when auto-reconnect fails. After reconnection, room state must resync using the same mechanism as foreground-return (per user decision: "重连后同步：与前后台切换保持一致").

Output: NetworkMonitor service, useNetworkStatus hook, NetworkBanner component, enhanced SocketManager reconnection UX
</objective>

<execution_context>
@C:/Users/MiaowFISH/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/MiaowFISH/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-playback-network-recovery/03-01-SUMMARY.md
@app/src/services/sync/StateReconciler.ts
@app/src/services/sync/SocketManager.ts
@app/src/components/common/ConnectionStatus.tsx
@app/src/components/common/Toast.tsx
@app/src/stores/index.tsx
@app/src/screens/PlayerScreen.tsx
@app/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: NetworkMonitor service + useNetworkStatus hook + install NetInfo</name>
  <files>
    app/src/services/sync/NetworkMonitor.ts
    app/src/hooks/useNetworkStatus.ts
    app/package.json
  </files>
  <action>
1. Install `@react-native-community/netinfo`:
   - Run `cd D:/Codespace/musesync/app && npx expo install @react-native-community/netinfo`

2. Create `app/src/services/sync/NetworkMonitor.ts`:
   - Import NetInfo from `@react-native-community/netinfo`
   - Import `socketManager` from `./SocketManager`
   - Import `stateReconciler` from `./StateReconciler`
   - Type `NetworkStatus = { isConnected: boolean; isInternetReachable: boolean | null; type: string }`
   - Class `NetworkMonitor`:
     - Private: `status: NetworkStatus`, `listeners: Set<(status: NetworkStatus) => void>`, `unsubscribeNetInfo: (() => void) | null`, `wasDisconnected: boolean = false`
     - `start()`: subscribe to `NetInfo.addEventListener(state => ...)`:
       - Update internal status
       - If transition from disconnected to connected (`wasDisconnected && isConnected`):
         - Log `[NetworkMonitor] Network recovered, triggering reconnection`
         - If socket is not connected, call `socketManager.connect()`
         - Wait for socket connection (poll or listen to socketManager state change)
         - Once connected, call `stateReconciler.reconcile({ roomId, userId, source: 'reconnection' })` — roomId/userId from socketManager's currentRoom context
         - Notify listeners with reconciliation result via a separate callback mechanism
       - Update `wasDisconnected = !isConnected`
       - Notify status listeners
     - `stop()`: unsubscribe from NetInfo
     - `getStatus(): NetworkStatus`
     - `onStatusChange(listener): () => void`: subscribe/unsubscribe pattern
     - `onReconnectionComplete(listener: (result) => void): () => void`: for components that need to react to reconnection sync results
   - Export singleton `networkMonitor`

3. Create `app/src/hooks/useNetworkStatus.ts`:
   - Import `networkMonitor` from services
   - Import `socketManager, ConnectionState` from SocketManager
   - `useNetworkStatus()` hook:
     - State: `networkStatus` from networkMonitor, `connectionState` from socketManager
     - useEffect to subscribe to both networkMonitor.onStatusChange and socketManager.onStateChange
     - Derived state:
       - `isOffline`: !networkStatus.isConnected
       - `isReconnecting`: connectionState === 'reconnecting'
       - `isConnectionError`: connectionState === 'error'
       - `showBanner`: isOffline || isReconnecting || isConnectionError
     - Return `{ isOffline, isReconnecting, isConnectionError, showBanner, networkStatus, connectionState }`
  </action>
  <verify>
    - `@react-native-community/netinfo` is in app/package.json dependencies
    - TypeScript compilation passes: `cd D:/Codespace/musesync && npx tsc --noEmit -p app/tsconfig.json`
    - NetworkMonitor can be imported and started
  </verify>
  <done>
    NetworkMonitor detects connectivity changes via NetInfo, triggers socket reconnection on recovery, and calls StateReconciler for post-reconnection sync. useNetworkStatus hook provides reactive network/connection state for UI.
  </done>
</task>

<task type="auto">
  <name>Task 2: NetworkBanner component + enhanced SocketManager + offline playback behavior</name>
  <files>
    app/src/components/common/NetworkBanner.tsx
    app/src/services/sync/SocketManager.ts
    app/src/hooks/useQueueSync.ts
    app/src/screens/PlayerScreen.tsx
    app/App.tsx
  </files>
  <action>
1. Create `app/src/components/common/NetworkBanner.tsx`:
   - Import `useNetworkStatus` hook
   - Import `socketManager` from services
   - Import `useTheme` from hooks
   - Import `Animated` from react-native for slide-in/out animation
   - Component `NetworkBanner`:
     - Use `useNetworkStatus()` to get `showBanner`, `isOffline`, `isReconnecting`, `isConnectionError`
     - If `!showBanner`, return null
     - Banner text logic (per user decision):
       - `isOffline`: '网络已断开，正在重连...' with red background (#F44336)
       - `isReconnecting`: '正在重连...' with yellow/orange background (#FF9800)
       - `isConnectionError`: '连接失败' with red background, plus a '重新连接' button
     - '重新连接' button: calls `socketManager.connect()` and resets reconnect count
     - Style: positioned at top of screen (below safe area), full width, padding 12px, text centered, white text
     - Animate in/out with Animated.View translateY or opacity
   - Export `NetworkBanner`

2. Enhance `app/src/services/sync/SocketManager.ts`:
   - Add `resetReconnectCount()` public method that sets `reconnectCount = 0` and `maxReconnectAttempts` back to default — called by manual retry button
   - In the `reconnect` event handler: after successful room rejoin, trigger reconciliation via `stateReconciler.reconcile()` if room context exists. Import stateReconciler at top.
   - Increase `maxReconnectAttempts` from 5 to 10 for better resilience
   - Adjust reconnection delays: initial 1s, max 30s (exponential backoff per user decision: 1s, 2s, 4s, 8s, 16s, 30s cap)
   - Update `RECONNECT_DELAY_MAX_MS` usage to 30000

3. Offline playback behavior in `app/src/hooks/useQueueSync.ts`:
   - In the auto-advance `handleTrackEnd` callback: check if network is connected (import `networkMonitor`)
   - If offline (`!networkMonitor.getStatus().isConnected`): do NOT auto-advance. Instead, stop playback and show toast '网络已断开，当前歌曲播放完毕' (per user decision: 断网后播完当前歌后停止，不切歌)
   - If online: proceed with normal auto-advance logic

4. Wire `NetworkBanner` in `app/App.tsx`:
   - Import `NetworkBanner`
   - Place it inside StoreProvider, above AppNavigator (so it overlays all screens)
   - Also start `networkMonitor` in the AppLifecycleWatcher component (or create one if not yet created by Plan 02)

5. Wire `NetworkBanner` in `app/src/screens/PlayerScreen.tsx`:
   - Import `NetworkBanner`
   - Place it at the top of the player screen layout, between the header and album art
   - This ensures the banner is visible on the most important screen
   - Alternatively, if the global banner in App.tsx is sufficient (overlays all screens), skip this step to avoid duplication
  </action>
  <verify>
    - TypeScript compilation passes
    - NetworkBanner renders with correct text for each state (offline, reconnecting, error)
    - Manual retry button is visible when connectionState is 'error'
    - Auto-advance is suppressed when offline
    - `npx tsc --noEmit -p app/tsconfig.json` passes
  </verify>
  <done>
    NetworkBanner displays disconnection status with appropriate colors and text. Manual '重新连接' button appears after max retries. SocketManager has enhanced reconnection with higher retry count and 30s max delay. Offline playback stops after current track without auto-advancing. Banner auto-dismisses on reconnection.
  </done>
</task>

</tasks>

<verification>
- Network disconnection: banner appears with '网络已断开，正在重连...'
- Auto-reconnection: exponential backoff 1s, 2s, 4s... up to 30s
- Max retries exceeded: banner shows '连接失败' with '重新连接' button
- Manual retry: button triggers fresh connection attempt
- Post-reconnection: room state resyncs automatically via StateReconciler, Toast shows changes
- Offline playback: current track continues, no auto-advance to next track
- Banner dismissal: disappears automatically when connection is restored
</verification>

<success_criteria>
- NetworkMonitor detects connectivity changes and triggers reconnection
- NetworkBanner shows correct state for offline/reconnecting/error
- Manual retry button works after max reconnection failures
- Auto-advance is suppressed when offline
- Post-reconnection sync uses StateReconciler (same as foreground-return)
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-playback-network-recovery/03-03-SUMMARY.md`
</output>
